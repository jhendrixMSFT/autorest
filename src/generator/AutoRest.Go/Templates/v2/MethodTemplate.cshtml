@using System.Collections.Generic;
@using System.Linq;
@using System.Text;
@using System;
@using AutoRest.Core.Model
@using AutoRest.Core.Utilities
@using AutoRest.Go
@using AutoRest.Go.Model

@inherits AutoRest.Core.Template<AutoRest.Go.Model.MethodGo>

@{
    var opIdCamelCase = Model.Name.ToCamelCase();
}

@WrapComment("// ", Model.Name + " " + Model.Description.ToSentence())
@if (Model.LocalParameters.Count() > 0)
{
@://
@WrapComment("// ", Model.ParametersDocumentation)
}

func (client @(Model.Owner)) @(Model.MethodSignature) (@Model.MethodReturnSignature(false)) {
@if (Model.ParameterValidations.Length > 0)
{
    @:if err := validation.Validate([]validation.Validation{
    @:@(Model.ParameterValidations)}); err != nil {
    @:return result, @(Model.ValidationError)
@:}
@:@EmptyLine
}
	req, err := client.@(opIdCamelCase)Preparer(@(Model.HelperInvocationParameters(false, false)))
	if err != nil {
		return
	}

	resp, err := client.RequestPolicyManager().InvokeRequest(ctx, requestpolicy.ResponderPolicyFactory{Responder: client.@(opIdCamelCase)Responder}, req)
	if err == nil {
		result = resp.(@(Model.MethodReturnType))
	} else {
		result.rawResponse = resp.Response()
	}

	return
}

@EmptyLine
// @(opIdCamelCase)Preparer prepares the @(Model.Name) request.
func (client @(Model.Owner)) @(opIdCamelCase)Preparer(@(Model.MethodParametersSignature(false))) (req requestpolicy.Request, err error) {
	req, err = requestpolicy.NewRequest("@(Model.HttpMethod.ToString().ToUpperInvariant())", *client.url, requestpolicy.NewRequestOptions{})
	if err != nil {
		return
	}

    params := req.URL.Query()
@foreach(var qp in Model.QueryParameters)
{
    var val = qp.ModelType.IsPrimaryType(KnownPrimaryType.String) ? qp.ValueForMap(false) : $"fmt.Sprintf(\"%v\", {qp.ValueForMap(false)})";
    if (qp.IsRequired)
    {
    @:params.Add("@(qp.NameForMap())", @(qp.IsConstant ? qp.DefaultValue.ToString() : val))
    }
    else
    {
    @:if @qp.Name != nil {
        @:params.Add("@(qp.NameForMap())", @(val))
    @:}
    }
}
    req.URL.RawQuery = params.Encode()
@foreach (var hp in Model.HeaderParameters)
{
    var val = hp.ModelType.IsPrimaryType(KnownPrimaryType.String) ? hp.ValueForMap(false) : $"fmt.Sprintf(\"%v\", {hp.ValueForMap(false)})";
    if (hp.IsRequired)
    {
        if (hp.IsAPIHeader)
        {
            val = "ServiceVersion";
        }
    @:req.AddHeader("@(hp.SerializedName)", @val)
    }
    else
    {
    @:if @hp.Name != nil {
        if (!hp.IsCustomMetadata)
        {
        @:req.AddHeader("@(hp.SerializedName)", @val)
        }
        else
        {
        @:req.AddHeadersWithPrefix("x-ms-meta-", @hp.ValueForMap(false))
        }
    @:}
    }
}
@if (Model.BodyParameter != null && !Model.BodyParameter.ModelType.PrimaryType(KnownPrimaryType.Stream))
{
    @:err = req.MarshalBody(requestpolicy.Content@(Model.Encoding.ToUpperInvariant()), @Model.GetBodyParamForDecorator())
}
else if (Model.BodyParameter != null && Model.BodyParameter.ModelType.PrimaryType(KnownPrimaryType.Stream))
{
    @:if @Model.BodyParameter.Name != nil {
        @:err = req.SetBody(@Model.BodyParameter.Name, nil)
    @:}
}
	return
}

@EmptyLine
// @(opIdCamelCase)Responder handles the response to the @(Model.Name) request.
func (client @(Model.Owner)) @(opIdCamelCase)Responder(resp requestpolicy.Response) (requestpolicy.Response, error) {
    var err error
@if (Model.ReturnValueRequiresUnmarshalling())
{
    @:defer func() {
        @:if cerr := resp.Response().Body.Close(); cerr != nil && err == nil {
            @:err = cerr
        @:}
    @:}()
}
	if err = requestpolicy.ValidateResponse(resp, @(string.Join(",", Model.ResponseCodes.ToArray()))); err != nil {
		return resp, err
	}
	result := @(Model.MethodReturnType){rawResponse: resp.Response()}
@if (Model.ReturnValueRequiresUnmarshalling())
{
    @:b, err := ioutil.ReadAll(resp.Response().Body)
    @:if err != nil {
        @:return resp, err
    @:}
    @:err = @(Model.Encoding).Unmarshal(b, &result)
    @:if err != nil {
        @:return resp, err
    @:}
}
	return result, nil
}
